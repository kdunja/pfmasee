<style>
  ::ng-deep .mat-table, 
  ::ng-deep .mat-row, 
  ::ng-deep .mat-header-row, 
  ::ng-deep .mat-cell, 
  ::ng-deep .mat-header-cell,
  ::ng-deep tr, 
  ::ng-deep td, 
  ::ng-deep th {
    border: none !important;
    border-bottom: none !important;
    box-shadow: none !important;
  }
  @media (max-width: 768px) {
  .mobile-wrapper {
    padding-left: 12px !important;
      padding-right: 12px !important;
  }
}
</style>

<div class="mobile-wrapper" style="max-width:950px; margin: 0 auto; background:#212842; overflow:hidden;">

  <!-- TRANSACTIONS TRAKA -->
  <div style="
    background: #2C365A;
    color: #FBF9E4;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    padding: 10px 24px;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  ">

  <!-- Leva strana: naslov -->
  <span>Transactions</span>

  <!-- Desna strana: dugmad -->
  <ng-container *ngIf="!multiSelectMode">
    <button
      mat-flat-button
      color="accent"
      (click)="startMultiSelect()"
      style="background:#373d64; color:#FBF9E4; border-radius:8px; min-width:140px; height:33px; font-size:13px; font-weight:600;">
      Categorize multiple
    </button>
  </ng-container>

<ng-container *ngIf="multiSelectMode">
  <div style="display: flex; gap: 10px;">
    <button
      mat-flat-button
      color="primary"
      (click)="proceedMultiCategorization()"
      [disabled]="selectedTransactionIds.length === 0"
      style="background:#5B88B2; color:#EEE8DF; border-radius:8px; min-width:140px; height:33px; font-size:13px; font-weight:600;">
      Proceed with categorization
    </button>

    <button
      mat-flat-button
      color="warn"
      (click)="cancelMultiSelect()"
      style="background:#c77d6b; color:#EEE8DF; border-radius:8px; min-width:110px; height:33px; font-size:13px; font-weight:600;">
      Cancel selection
    </button>
  </div>
</ng-container>


</div>

</div>

  <table mat-table [dataSource]="dataSource" style="border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; border-top-left-radius: 0; border-top-right-radius: 0;overflow: hidden;width:100%;font-size:11px;font-family:'Inter','Montserrat',Arial,sans-serif;color:#e5fff6;background:#373d64;">
    <!-- NAME + ID -->
    <ng-container matColumnDef="beneficiary">
      <th mat-header-cell *matHeaderCellDef>
</th>
      <td mat-cell *matCellDef="let element" style="padding:14px 24px 14px 24px;">
        <div style="display:flex;flex-direction:column;">
          <span style="font-size: 13px;font-weight:600;color:#FBF9E4;">{{element['beneficiary-name']}}</span>
          <span style="font-size:10px;color:#C4BCB0;">ID: {{element.id}}</span>
        </div>
      </td>
    </ng-container>

    <!-- DATE -->
    <ng-container matColumnDef="date">
  <th mat-header-cell *matHeaderCellDef>
  </th>
  <td mat-cell *matCellDef="let element"
      style="padding:10px 8px; width:110px; font-size:13px; color:#FBF9E4; text-align:left;">
    {{element.date | date:'dd.MM.yyyy'}}
  </td>
</ng-container>


    <!-- AMOUNT + ARROW -->
    <ng-container matColumnDef="amount">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let element"
    style="font-size:13px; font-weight:400; padding:10px 8px; color:#FBF9E4;">
  
  <div style="display:flex; align-items:center; gap:4px;">
    <mat-icon
      style="font-size:17px;"
      [style.color]="element.direction === 'd' ? '#f04d5e' : '#43cb8e'">
      {{element.direction === 'd' ? 'arrow_downward' : (element.direction === 'c' ? 'arrow_upward' : '')}}
    </mat-icon>
    <span>$</span>
    <span>{{element.amount | number:'1.2-2'}}</span>
  </div>

</td>
    </ng-container>

    <!-- DESCRIPTION + CATEGORY + SPLIT + CHECKBOX -->
    <ng-container matColumnDef="description">
  <th mat-header-cell *matHeaderCellDef></th>

  <td mat-cell *matCellDef="let element" style="font-size: 13px; padding:10px 8px; position:relative;">
    
    <!-- DESKTOP PRIKAZ -->
    <div *ngIf="!isMobileView" style="display:flex; align-items:center; justify-content: space-between; gap:12px; min-height:38px;">
      
      <!-- Leva strana -->
      <div style="display:flex; align-items:center; gap:10px;">
        <input
          *ngIf="multiSelectMode"
          type="checkbox"
          [checked]="selectedTransactionIds.includes(element.id)"
          (change)="toggleTransactionSelection(element.id)"
          style="width:18px; height:18px; accent-color:#2C365A; background:#1c2c27;"
        />
        <div style="display:flex; flex-direction:column; min-width:120px;">
          <span style="color:#FBF9E4;">{{element.description}}</span>
          <span style="font-size:10px; color:#C4BCB0;">Kind: {{element.kind}}</span>
        </div>
      </div>

      <!-- Desna strana -->
      <div style="padding:10px 24px 10px 16px; display:flex; align-items:center; gap:8px;">
        <button mat-flat-button
        (click)="openCategoryModal(element)"
        [disabled]="multiSelectMode"
        [ngStyle]="element.categoryId ? {
          'background': '#5B88B2',
          'color': '#FBF9E4',
          'border': 'none'
        } : {
          'background': '#2C365A',
          'color': '#e5fff6',
          'border': '1px solid #5B88B2'
        }"
        style="font-size:12px; padding:4px 14px; min-width:100px; height:28px;
               border-radius:8px; font-weight:500; white-space:nowrap; text-align:center;">
  <ng-container *ngIf="element.categoryId; else addText">
    {{ getCategoryName(element.categoryId) }}
  </ng-container>
  <ng-template #addText>Add category</ng-template>
</button>

        <button *ngIf="!element.isSplit"
                mat-stroked-button
                style="font-size:12px; padding:4px 14px; height:28px; min-width:70px;
                       color:#e5fff6; border-radius:8px; background:#2C365A;
                       border: 1px solid #5B88B2;"
                (click)="onSplitTransaction(element)"
                [disabled]="multiSelectMode">
          Split
        </button>

        <span *ngIf="element.isSplit" style="font-size:11px; color:#8cb6ff;">
          Split: {{ getSplitCategories(element.id).join(', ') }}
        </span>
      </div>
    </div>

  <!-- MOBILNI prikaz: dugmad ispod u kružnom meniju -->
<!-- MOBILNI prikaz: dugmad u kružnom meniju -->
<div *ngIf="isMobileView" style="position: relative; width: 100%; min-height: 40px;">
  <!-- Dugme sa tri tačke -->
  <div style="position: relative; z-index: 10;">
    <button (click)="toggleActionsFor(element.id)"
            style="background: none; border: none; cursor: pointer; float: right;">
      <span class="material-icons" style="color: #FBF9E4; font-size: 20px;">more_vert</span>
    </button>
  </div>

  <!-- Meni koji se otvara ulevo -->
  <div *ngIf="activeActionId === element.id"
       style="position: fixed; top: auto; right: 80px;
              background: #2C365A;
              padding: 12px; border-radius: 12px; display: flex;
              flex-direction: column; gap: 12px; z-index: 9999;
              box-shadow: 0 4px 12px #0007; align-items: center;">

    <!-- Add category -->
    <button (click)="openCategoryModal(element)"
            style="width: 42px; height: 42px; border-radius: 50%;
                   background: #5B88B2; border: none; display: flex;
                   align-items: center; justify-content: center; color: white;">
      <span class="material-icons" style="font-size: 22px;">add</span>
    </button>

    <!-- Split -->
    <button (click)="onSplitTransaction(element)"
            style="width: 42px; height: 42px; border-radius: 50%;
                   background: #2C365A; border: 1px solid #5B88B2;
                   display: flex; align-items: center; justify-content: center; color: white;">
      <span class="material-icons" style="font-size: 20px;">call_split</span>
    </button>
  </div>
</div>

  </td>
</ng-container>


<!-- DATA REDOVI -->
<tr mat-row *matRowDef="let row; columns: displayedColumns"
    style="background:#131936;">
</tr>

  </table>

<!-- MODAL ZA KATEGORIJU (SINGLE/MULTI) -->
<div *ngIf="showCategoryModal"
  style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,40,60,0.20);display:flex;align-items:center;justify-content:center;z-index:2000;">
  <div style="background-color: rgba(190, 220, 240, 0.4); backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);padding:30px 28px 22px 28px;border-radius:18px;min-width:330px;min-height:90px;display:flex;flex-direction:column;">
    <h3 style="margin-bottom:18px;color:#2C365A;">
      {{multiSelectMode ? ('You have selected ' + selectedTransactionIds.length + ' transactions for categorization') : 'Choose category'}}
    </h3>
    <!-- Dropdown za kategoriju -->
    <div style="margin-bottom:18px;">
      <label for="categorySelect" style="font-size:14px;font-weight:500;color:#2C365A;">Category:</label><br>
      <select id="categorySelect" name="categorySelect"
              [(ngModel)]="selectedCategoryId"
              style="padding:6px 10px;border-radius:7px;;font-size:13.5px;min-width:160px;background:#2C365A;color:#FBF9E4;">
        <option [ngValue]="null" disabled>Choose category</option>
        <option *ngFor="let cat of categories" [ngValue]="cat.id">{{cat.name}}</option>
      </select>
    </div>
    <!-- Dropdown za podkategoriju -->
    <div>
      <label for="subcategorySelect" style="font-size:14px;color:#2C365A;font-weight:500;">Subcategory:</label><br>
      <select id="subcategorySelect" name="subcategorySelect"
              [(ngModel)]="selectedSubcategoryId"
              [disabled]="!selectedCategoryId"
              style="padding:6px 10px;border-radius:7px;font-size:13.5px;min-width:160px;background:#2C365A;color:#FBF9E4;">
        <option [ngValue]="null" disabled>Choose subcategory (optional)</option>
        <option *ngFor="let sub of filteredSubcategories" [ngValue]="sub.id">{{sub.name}}</option>
      </select>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:24px;gap:10px;">
      <button (click)="closeCategoryModal()" style="background:#f04d5e;color:#FBF9E4;border: none;padding:6px 16px;border-radius:8px;">Cancel</button>
      <button (click)="applyCategory()" style="background:#48bd89;color:#FBF9E4;border:none;padding:6px 16px;border-radius:8px;font-weight:400;">Apply</button>
    </div>
  </div>
</div>

<!-- MODAL ZA SPLIT TRANSACTION -->
<div *ngIf="splitModalOpen"
   style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,40,60,0.20);display:flex;align-items:center;justify-content:center;z-index:2100;">
  <div style="background-color: rgba(190, 220, 240, 0.4); backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);padding:30px 28px 22px 28px;border-radius:18px;min-width:390px;min-height:90px;box-shadow:0 4px 32px #1c2c2788;display:flex;flex-direction:column;">
    <h3 style="margin-bottom:8px;color:#212842;">Split transaction</h3>
    <div style="color:#212842;font-size:14px;margin-bottom:14px;">Please split the transaction to categories:</div>
    <ng-container *ngFor="let part of splitParts; let i = index;">
      <div style="border:1px solid #212842;border-radius:9px;margin-bottom:14px;padding:12px 12px 8px 12px;position:relative;display:flex;align-items:center;gap:8px;">
        <!-- Kategorija -->
        <select [(ngModel)]="splitParts[i].categoryId"
                style="padding:6px 10px;border-radius:7px;font-size:13.5px;min-width:180px;background:#212842;color:#FBF9E4;">
          <option [ngValue]="null" disabled>Choose category</option>
          <option *ngFor="let cat of categories" [ngValue]="cat.id">{{cat.name}}</option>
        </select>
        <!-- Podkategorija -->
        <select [(ngModel)]="splitParts[i].subcategoryId"
                [disabled]="!splitParts[i].categoryId"
                style="padding:6px 10px;border-radius:7px;font-size:13.5px;min-width:180px;background:#212842;color:#FBF9E4;">
          <option [ngValue]="null" disabled>Choose subcategory (optional)</option>
          <option *ngFor="let sub of getFilteredSplitSubcategories(splitParts[i].categoryId)" [ngValue]="sub.id">{{sub.name}}</option>
        </select>
        <!-- Amount -->
        <input type="number" min="0.01" step="0.01"
               placeholder="Amount"
               [(ngModel)]="splitParts[i].amount"
               style="font-size:13.5px;padding:6px 10px;border:none;border-radius:7px;width:110px;background:#212842;color:#FBF9E4;">
        <!-- Remove split -->
        <button *ngIf="splitParts.length > 2"
                (click)="removeSplitPart(i)"
                style="background:#f04d5e;color:#FBF9E4;margin-left:8px;font-size:18px;cursor:pointer;">
          ✕
        </button>
      </div>
    </ng-container>
    <div style="margin-bottom:18px;">
      <button (click)="addSplitPart()" style="background:none;color:#212842;border:none;font-size:16px;cursor:pointer;">+ Add new category</button>
    </div>
    <div style="color: #620000; font-size:14px; font-weight:400; min-height:18px;">
      <span *ngIf="splitOriginal && splitSum() !== splitOriginal.amount">
        Total must be {{splitOriginal.amount}} (current: {{splitSum() || 0}})
      </span>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:10px;">
      <button (click)="closeSplitModal()" style="background:#f04d5e;color:#FBF9E4;border: none;padding:6px 16px;border-radius:8px;font-weight:400;">Cancel</button>
      <button (click)="applySplit()" [disabled]="splitSum() !== splitOriginal.amount"
              style="background:#48bd89;color:#FBF9E4;border:none;padding:6px 16px;border-radius:8px;font-weight:400;">
        Apply
      </button>
    </div>
  </div>
</div>